<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modo Hotel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1F2A44 0%, #3A4A64 100%);
      min-height: 100vh;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: #F3EFEA;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    h1 {
      color: #1F2A44;
      font-size: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1F2A44 0%, #2A3A5C 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(31,42,68,0.5);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .section {
      background: #F3EFEA;
      padding: 30px;
      margin-bottom: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .section h2 {
      color: #1F2A44;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #1F2A44;
    }

    .hotel-info {
      background: linear-gradient(135deg, #F3EFEA 0%, #E5DED5 100%);
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .hotel-info h3 {
      color: #333;
      font-size: 1.4rem;
      margin-bottom: 10px;
    }

    .hotel-info p {
      color: #555;
      margin: 5px 0;
    }

    .intention-card {
      background: linear-gradient(135deg, #F3EFEA 0%, #E5DED5 100%);
      padding: 25px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #1F2A44;
    }

    .intention-card h3 {
      color: #333;
      font-size: 1.3rem;
      margin-bottom: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
      color: #555;
    }

    .existing-offer {
      background: #fff3cd;
      padding: 20px;
      margin-top: 15px;
      border-radius: 10px;
      border-left: 4px solid #ffc107;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .existing-offer h4 {
      color: #856404;
      margin-bottom: 10px;
    }

    .offer-form {
      background: white;
      padding: 20px;
      margin-top: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .offer-form h4 {
      color: #1F2A44;
      margin-bottom: 15px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .checkbox-item:hover {
      background: #e9ecef;
    }

    .checkbox-item input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      cursor: pointer;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-weight: normal;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      border: 1px solid #ffeaa7;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    @media (max-width: 768px) {
      .info-grid {
        grid-template-columns: 1fr;
      }

      .checkbox-group {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè® Modo Hotel</h1>
      <button class="btn btn-secondary" onclick="location.href='index.html'">‚Üê Volver</button>
    </header>

    <div class="section">
      <h2>üè¢ Seleccionar Hotel</h2>
      <select id="hotelId" onchange="loadHotelInfo()">
        <option value="">Cargando...</option>
      </select>
      <div id="hotelInfo"></div>
    </div>

    <div class="section">
      <h2>üìã Intenciones Activas en Tu Ciudad</h2>
      <button class="btn btn-primary" onclick="loadIntentions()">üîÑ Actualizar</button>
      <div id="intentions"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    let currentHotel = null;
    let intentionsWithOffers = {};

    const AVAILABLE_EXTRAS = [
      { id: 'breakfast', label: 'Desayuno incluido' },
      { id: 'wifi', label: 'WiFi gratis' },
      { id: 'parking', label: 'Estacionamiento' },
      { id: 'pool', label: 'Piscina' },
      { id: 'gym', label: 'Gimnasio' },
      { id: 'spa', label: 'Spa' },
      { id: 'shuttle', label: 'Traslado aeropuerto' },
      { id: 'room-service', label: 'Servicio a habitaci√≥n' }
    ];

    async function loadHotels() {
      try {
        const response = await fetch(`${API_URL}/hotels`);
        const hotels = await response.json();
        const select = document.getElementById('hotelId');
        select.innerHTML = hotels.map(h => `<option value="${h.id}">${h.name} - ${h.city}</option>`).join('');
        if (hotels.length > 0) {
          loadHotelInfo();
        }
      } catch (error) {
        console.error('Error loading hotels:', error);
      }
    }

    async function loadHotelInfo() {
      const hotelId = document.getElementById('hotelId').value;
      if (!hotelId) return;

      try {
        const response = await fetch(`${API_URL}/hotels`);
        const hotels = await response.json();
        currentHotel = hotels.find(h => h.id == hotelId);

        if (currentHotel) {
          document.getElementById('hotelInfo').innerHTML = `
            <div class="hotel-info">
              <h3>üè® ${currentHotel.name}</h3>
              <p><strong>üìç Ciudad:</strong> ${currentHotel.city}</p>
              <p><strong>üí∞ Precio M√≠nimo:</strong> $${currentHotel.min_price}</p>
            </div>
          `;
          loadIntentions();
        }
      } catch (error) {
        console.error('Error loading hotel info:', error);
      }
    }

    async function loadIntentions() {
      if (!currentHotel) return;

      try {
        const response = await fetch(`${API_URL}/intentions/city/${currentHotel.city}`);
        const intentions = await response.json();

        const intentionsDiv = document.getElementById('intentions');
        if (intentions.length === 0) {
          intentionsDiv.innerHTML = '<p style="text-align:center; color:#666; margin-top:20px;">No hay intenciones activas en tu ciudad</p>';
          return;
        }

        let html = '';
        for (const intention of intentions) {
          const offers = await loadOffersForIntention(intention.id);
          const myOffer = offers.find(o => o.hotel_id === currentHotel.id);
          intentionsWithOffers[intention.id] = myOffer;

          html += `
            <div class="intention-card">
              <h3>üéØ Intenci√≥n #${intention.id}</h3>
              <div class="info-grid">
                <div><strong>üìÖ Check-in:</strong> ${intention.check_in}</div>
                <div><strong>üìÖ Check-out:</strong> ${intention.check_out}</div>
                <div><strong>üí∞ Precio m√°x:</strong> $${intention.max_price}</div>
                <div><strong>üìä Total ofertas:</strong> ${offers.length}</div>
              </div>

              ${myOffer ? `
                <div class="existing-offer">
                  <h4>‚úÖ Tu Oferta</h4>
                  <p><strong>Precio:</strong> $${myOffer.price}</p>
                  <p><strong>Servicios:</strong> ${myOffer.extras || 'Ninguno'}</p>
                  <p><strong>Actualizaciones usadas:</strong> ${myOffer.updates_count} / 2</p>
                  ${myOffer.updates_count < 2 ? `
                    <button class="btn btn-primary" onclick="showUpdateForm(${intention.id}, ${myOffer.id})">‚úèÔ∏è Actualizar Oferta</button>
                    <div id="updateForm-${intention.id}" style="display:none;" class="offer-form">
                      <h4>Actualizar Oferta</h4>
                      <div class="form-group">
                        <label>üí∞ Precio ($):</label>
                        <input type="number" id="updatePrice-${intention.id}" value="${myOffer.price}">
                        <small style="color:#666;">M√≠n: $${currentHotel.min_price}, M√°x: $${intention.max_price}</small>
                      </div>
                      <div class="form-group">
                        <label>üéÅ Servicios Adicionales:</label>
                        <div class="checkbox-group" id="updateExtras-${intention.id}">
                          ${generateCheckboxes(myOffer.extras, `updateExtras-${intention.id}`)}
                        </div>
                      </div>
                      <div class="actions">
                        <button class="btn btn-primary" onclick="updateOffer(${myOffer.id}, ${intention.id})">üíæ Guardar</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('updateForm-${intention.id}').style.display='none'">‚úñÔ∏è Cancelar</button>
                      </div>
                      <div id="updateMessage-${intention.id}"></div>
                    </div>
                  ` : '<div class="warning">‚ö†Ô∏è M√°ximo de actualizaciones alcanzado</div>'}
                </div>
              ` : `
                <button class="btn btn-primary" onclick="showOfferForm(${intention.id})">‚ûï Hacer Oferta</button>
                <div id="offerForm-${intention.id}" style="display:none;" class="offer-form">
                  <h4>Crear Nueva Oferta</h4>
                  <div class="form-group">
                    <label>üí∞ Precio ($):</label>
                    <input type="number" id="price-${intention.id}" placeholder="Ingresa el precio">
                    <small style="color:#666;">M√≠n: $${currentHotel.min_price}, M√°x: $${intention.max_price}</small>
                  </div>
                  <div class="form-group">
                    <label>üéÅ Servicios Adicionales (opcional):</label>
                    <div class="checkbox-group" id="extras-${intention.id}">
                      ${generateCheckboxes('', `extras-${intention.id}`)}
                    </div>
                  </div>
                  <div class="actions">
                    <button class="btn btn-primary" onclick="createOffer(${intention.id})">‚úì Enviar Oferta</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('offerForm-${intention.id}').style.display='none'">‚úñÔ∏è Cancelar</button>
                  </div>
                  <div id="message-${intention.id}"></div>
                </div>
              `}
            </div>
          `;
        }
        intentionsDiv.innerHTML = html;
      } catch (error) {
        console.error('Error loading intentions:', error);
      }
    }

    function generateCheckboxes(selectedExtras, containerId) {
      const selected = selectedExtras ? selectedExtras.split(', ') : [];
      return AVAILABLE_EXTRAS.map(extra => `
        <div class="checkbox-item">
          <input type="checkbox" id="${containerId}-${extra.id}" value="${extra.label}" ${selected.includes(extra.label) ? 'checked' : ''}>
          <label for="${containerId}-${extra.id}">${extra.label}</label>
        </div>
      `).join('');
    }

    function getSelectedExtras(containerId) {
      const checkboxes = document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`);
      return Array.from(checkboxes).map(cb => cb.value).join(', ');
    }

    async function loadOffersForIntention(intentionId) {
      try {
        const response = await fetch(`${API_URL}/intentions/${intentionId}/offers`);
        return await response.json();
      } catch (error) {
        console.error('Error loading offers:', error);
        return [];
      }
    }

    function showOfferForm(intentionId) {
      document.getElementById(`offerForm-${intentionId}`).style.display = 'block';
    }

    function showUpdateForm(intentionId, offerId) {
      document.getElementById(`updateForm-${intentionId}`).style.display = 'block';
    }

    async function createOffer(intentionId) {
      const price = document.getElementById(`price-${intentionId}`).value;
      const extras = getSelectedExtras(`extras-${intentionId}`);
      const messageDiv = document.getElementById(`message-${intentionId}`);

      if (!price) {
        messageDiv.innerHTML = '<div class="message error">Por favor, ingresa un precio</div>';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/offers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            intention_id: intentionId,
            hotel_id: currentHotel.id,
            price: parseInt(price),
            extras: extras
          })
        });

        if (response.ok) {
          messageDiv.innerHTML = '<div class="message success">¬°Oferta creada exitosamente!</div>';
          setTimeout(() => loadIntentions(), 1000);
        } else {
          const error = await response.json();
          messageDiv.innerHTML = `<div class="message error">Error: ${error.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
      }
    }

    async function updateOffer(offerId, intentionId) {
      const price = document.getElementById(`updatePrice-${intentionId}`).value;
      const extras = getSelectedExtras(`updateExtras-${intentionId}`);
      const messageDiv = document.getElementById(`updateMessage-${intentionId}`);

      if (!price) {
        messageDiv.innerHTML = '<div class="message error">Por favor, ingresa un precio</div>';
        return;
      }

      try {
        const response = await fetch(`${API_URL}/offers/${offerId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            price: parseInt(price),
            extras: extras
          })
        });

        if (response.ok) {
          messageDiv.innerHTML = '<div class="message success">¬°Oferta actualizada exitosamente!</div>';
          setTimeout(() => loadIntentions(), 1000);
        } else {
          const error = await response.json();
          messageDiv.innerHTML = `<div class="message error">Error: ${error.error}</div>`;
        }
      } catch (error) {
        messageDiv.innerHTML = `<div class="message error">Error: ${error.message}</div>`;
      }
    }

    loadHotels();
  </script>
</body>
</html>
